BootStrap: docker
From: python:3.10-slim

%environment
    export DATA_PATH=/data
    export PATH=/root/.local/bin:$PATH
    export PYTHONPATH=/code/src

%files
    uv.lock /code/uv.lock
    pyproject.toml /code/pyproject.toml
    src /code/src
    scripts /code/scripts
    README.md /code/README.md

%post
    export PATH=/root/.local/bin:$PATH
    export PYTHONPATH=/code/src

    apt-get update
    apt-get install --no-install-recommends curl ffmpeg -y

    mkdir /cargo
    curl -LsSf https://astral.sh/uv/install.sh | CARGO_HOME=/cargo sh
    echo "export PATH=/cargo/bin:\$PATH" >> $APPTAINER_ENVIRONMENT

    cd /code
    UV_PROJECT_ENVIRONMENT=/tmp/.venv uv sync --no-cache

%runscript
    cd /code
    UV_PROJECT_ENVIRONMENT=/tmp/.venv uv --no-cache run "$@"

%labels
    Author Kieran Gibb
    Version 1.0
    Description "Run birdnetlib on files specified by an index parquet file"
